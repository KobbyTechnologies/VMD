{% extends 'base.html' %}
{% load static %}
{% block base %}

<!--Header-->
{% include 'navbar.html' %}
<!-- End Header -->
<!-- Sidebar-->
{% include 'sidebar.html' %}
<!-- End Sidebar -->
<style>
    .cert_img {
        height: 190px !important;
        width: 190px !important;
        margin-bottom: 1rem;

    }

    .cert_div {
        justify-content: center;
        align-items: center;
    }
</style>
<main id="main" class="main">
    <div class="pagetitle">
        <div class="row">
            <div class="col-md-8">
                <h1 class="my-2">Retailer Dealer Premises Permit</h1>
            </div>
            <div class="col-md-4 text-right">
                <label class="my-2">Document Status: <span
                        class="document_status text-small text-primary"></span></label>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" aria-valuenow="20" aria-valuemin="20"
                        aria-valuemax="100"><span class="doc_status">20%</span></div>
                </div>
            </div>
        </div>
    </div>
    <section class="section contact">
        <div class="row">
            <div class="col-md-12">
                <div class="loader mx-auto text-center" id="spinner" style="display: none;">
                    <div class="loader__bar"></div>
                    <div class="loader__bar"></div>
                    <div class="loader__bar"></div>
                    <div class="loader__bar"></div>
                    <div class="loader__bar"></div>
                    <div class="loader__ball"></div>
                </div>
                <div id="stepTwo" class="bg-white p-4" style="display: none">
                    <div class="premise_data" id="premise_data">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title">
                                Other Professionals Working in the Premise
                            </h5>
                            <div id="Professionals_btn" style="display: none">
                                <button class="btn btn-primary" id="ProfessionalsNext">Next Step <i
                                        class="las la-angle-double-right"></i></button>
                            </div>
                        </div>
                        <table id="ProfessionalsTable"
                            class="table w-100 table-striped dt-responsive table-responsive-lg table-bordered datatable">
                            <thead>
                                <tr>
                                    <th scope="col">Name</th>
                                    <th scope="col">Pro Reg No.</th>
                                    <th scope="col">Nationality</th>
                                    <th scope="col">ID/Passport/Alien ID No.</th>
                                    <th scope="col">Position</th>
                                    <th scope="col">Qualification</th>
                                    <th scope="col">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                        <form method="POST" id="ProfessionalsForm">
                            {% csrf_token %}
                            <p class="text-small text-info"><i class="las la-plus"></i> Add Professional</p>
                            <input type="hidden" name="myAction" id="Professionals_my_action" value="insert">
                            <input type="hidden" name="lineNo" id="Professionals_lineNo" value="">
                            <div class="row gx-2">
                                <div class="col-md-8">
                                    <label class="form-label">Full Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="pro_name" id="pro_name" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Professional Reg No. </label>
                                    <input type="text" class="form-control" name="professionalRegNo"
                                        id="professionalRegNo" required>
                                </div>
                            </div>
                            <div class="row my-3 gx-2">
                                <div class="col-md-4">
                                    <label class="form-label">Nationality <span class="text-danger">*</span></label>
                                    <select class="form-select" aria-label="Default select example" name="nationality"
                                        id="nationality">
                                        <option selected disabled value="0">Choose...</option>
                                        {% for res in country %}
                                        <option value="{{res.Code}}">{{res.Name}}</option>
                                        {% empty %}
                                        <option value="KE">KENYA</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">ID/Passport/Alien ID No <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="iDorPassportOrAlienIDNo"
                                        id="iDorPassportOrAlienIDNo">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Position in the Business<span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="position_in_business"
                                        id="position_in_business" required>
                                </div>
                            </div>
                            <div class="row my-3">
                                <div class="col-md-12">
                                    <div class="mb-2">
                                        <label class="form-label">Qualification And Experience <span
                                                class="text-danger">*</span></label>
                                        <textarea class="form-control longText" name="qualificationAndExperience"
                                            id="qualificationAndExperience"></textarea>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn button-87 my-2 w-100">Submit</button>
                        </form>
                    </div>
                </div>
                <div class="stepThree" id="stepThree" style="display: none">
                    <div class="row m-0 bg-white p-4">
                        <div class="Attachment_data" id="Attachment_data">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title">
                                    Attachment
                                </h5>
                                <div id="AttachmentsBtns">
                                    <button class="btn btn-secondary" id="AttachmentsPrev"><i
                                            class="las la-angle-double-left"></i> Prev
                                        Step</button>
                                    <button class="btn btn-primary" id="AttachmentsNext">Next Step <i
                                            class="las la-angle-double-right"></i></button>
                                </div>
                            </div>
                            {% if permit.Status == 'Open' %}
                            <form method="POST" id="attachmentForm">
                                {% csrf_token %}
                                <input type="hidden" name="myAction" id="Professionals_my_action" value="insert">
                                <input type="hidden" name="lineNo" id="Professionals_lineNo" value="">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-2">
                                            <label class="form-label">Upload Attachment <span
                                                    class="text-danger">*</span></label>
                                            <input type="file" class="form-control" name="attachments" id="attachments"
                                                accept=".doc,.docx,.pdf">
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn button-87 my-2 w-100">Upload</button>
                            </form>
                            {% endif %}
                        </div>
                        <div class="row my-3" id="attachments-container">

                        </div>
                    </div>
                </div>
                <div class="stepFour" id="stepFour" style="display: none">
                    <div class="row my-2">

                    </div>
                    <div class="row m-0">
                        <div class="col-md-12 bg-white my-2">
                            <div class="d-flex justify-content-end align-items-center my-3">
                                <div id="payment_btn">
                                    <button class="btn btn-secondary" id="paymentPrev"><i
                                            class="las la-angle-double-left"></i> Prev
                                        Step</button>
                                    <form method="post" id="payment_submit_form" style="display:none">
                                        {% csrf_token %}
                                        <button class="btn btn-warning" id="payment_submit">Submit </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-12">
                            <div class="row">
                                <div class="col-12 mb-4">
                                    <div class="row box-right">
                                        <div class="col-md-8 ps-0 ">
                                            <p class="ps-3 textmuted fw-bold h6 mb-2"><span
                                                    class="bi bi-circle-fill pe-2" style="color:#0e5a8d;"></span> <span
                                                    id="payment_state">Total
                                                    to Pay</span></p>
                                            <p class="h1 fw-bold d-flex"> <span
                                                    class="las la-coins textmuted pe-1 h6 align-text-top mt-2"></span>
                                                <span class="pesa_paid">{{permit.Currency}}
                                                    {{permit.AmountPayable}}</span>
                                            </p>
                                        </div>
                                    </div>
                                    {% if permit.Status == 'Approved' %}
                                    <div class="row box-right my-3" id="cert_card" style="display:none">
                                        <div class="col-md-12 text-center cert_div">
                                            <img src="../../static/img/certificate.png" class="img-fluid cert_img"
                                                alt="">
                                            <form id="PremiseCertForm" method="post">
                                                {% csrf_token %}
                                                <button type="submit" class="button-87">
                                                    <i class="las la-download"></i> Download Wholesale Premise Permit
                                                    Certificate
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-12 px-0 mb-4">
                                    {% if permit.Status == 'Open' %}
                                    <div class="box-right confirm_div">
                                        <div class="d-flex">
                                            <p class="fw-bold h7">Confirm Payment</p>

                                            <p class="ms-auto p-blue"> <span
                                                    class=" bg btn btn-primary bi bi-exclamation-circle"></span>
                                            </p>
                                        </div>
                                        <div class="bg-blue px-2">
                                            <P class="textmuted">VMD will never ask you for your password, PIN, CVV,
                                                or
                                                full card details.
                                            </P>
                                        </div>
                                        <form action="#" method="POST">
                                            {% csrf_token %}
                                            <input type="hidden" name="currency" value="{{res.Currency_Code}}">
                                            <div class="row my-3">
                                                <div class="col-md-12">
                                                    <label for="" class="form-label">Reference Number <span
                                                            class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" name="transactionCode"
                                                        required>
                                                    <div class="form-text">Enter transaction or reference number to
                                                        confirm payment
                                                    </div>
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-primary d-block w-100">Confirm
                                                Payment
                                                <span class="ms-3 bi bi-arrow-right"></span>
                                            </button>
                                        </form>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-12 ps-md-5 p-0 ">
                            <div class="box-left">
                                <div class="">
                                    <p class="h7 fw-bold mb-1">Make Payments</p>
                                    <p class="textmuted h8 mb-2">Choose from the payment options available to proceed.
                                        Your payment
                                        will be processed
                                        immediately.
                                    </p>
                                    <form id="FNGenerateInvoice" method="post">
                                        {% csrf_token %}
                                        <button type='submit' class="button-87 w-100 my-3">Preview Invoice</button>
                                    </form>
                                    <!-- Bordered Tabs Justified -->
                                    <ul class="nav nav-tabs nav-tabs-bordered d-flex" id="borderedTabJustified"
                                        role="tablist">
                                        <li class="nav-item flex-fill" role="presentation">
                                            <button class="nav-link w-100 active" id="home-tab" data-bs-toggle="tab"
                                                data-bs-target="#bordered-justified-home" type="button" role="tab"
                                                aria-controls="home" aria-selected="true">Bank</button>
                                        </li>
                                        <li class="nav-item flex-fill" role="presentation">
                                            <button class="nav-link w-100" id="profile-tab" data-bs-toggle="tab"
                                                data-bs-target="#bordered-justified-profile" type="button" role="tab"
                                                aria-controls="profile" aria-selected="false">M-Pesa</button>
                                        </li>
                                    </ul>
                                    <div class="tab-content pt-5" id="borderedTabJustifiedContent">
                                        <div class="tab-pane fade show active" id="bordered-justified-home"
                                            role="tabpanel" aria-labelledby="home-tab">
                                            <div class="form">
                                                <p>Bank: <span class="text-primary">National Bank of Kenya</span></p>
                                                <p>Bank Name: <span class="text-primary">Veterinary Medicines
                                                        Directorate</span></p>
                                                <p>Branch: <span class="text-primary">Westlands</span></p>
                                                <p>Swift Code: <span class="text-primary">NBKEKENXXXX</span></p>
                                                <p>Kshs A/C No.: <span class="text-primary">01071203347300</span></p>
                                                <p>USD A/C No.<span class="text-primary">02071203347300</span></p>
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="bordered-justified-profile" role="tabpanel"
                                            aria-labelledby="profile-tab">
                                            <div class="form">
                                                <p>PayBill: <span class="text-primary">471524</span></p>
                                                <p>Kshs A/C No.: <span class="text-primary">01071203347300</span></p>
                                                <p>USD A/C No.<span class="text-primary">02071203347300</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="accordion" id="accordionExample">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                Retailer Dealers Premises Permit {{permit.RetailDealersNo}} Details
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne"
                            data-bs-parent="#accordionExample">
                            <div class="accordion-body">
                                <form action="{% url 'RetailersPermit' %}" class="bg-white p-4" method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="retailDealersNo" value="{{permit.RetailDealersNo}}">
                                    <input type="hidden" name="myAction" id="myAction" value="modify">
                                    <input type="hidden" name="iAgree" value="True">
                                    <div class="tab">
                                        <div class="border border-success rounded p-3 my-3">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <label class="form-label">Applicant Name </label>
                                                    <input type="text" class="form-control" name="applicantName"
                                                        id="applicantName" value="{{permit.ApplicantName}}" disabled>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Application Date</label>
                                                    <input type="text" class="form-control"
                                                        value="{{permit.ApplicationDate}}" disabled>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Amount Payable</label>
                                                    <input type="text" class="form-control"
                                                        value="{{permit.AmountPayable}}" disabled>
                                                </div>
                                            </div>
                                            <div class="row my-3">
                                                <div class="col-md-4">
                                                    <label class="form-label">First Time Application <span
                                                            class="text-danger">*</span></label>
                                                    <select class="form-select" aria-label="Default select example"
                                                        name="firstTimeApplication" id="firstTimeApplication" disabled>
                                                        <option value="0">--select--</option>
                                                        <option value="1">Yes</option>
                                                        <option value="2">True</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Previous Inspection </label>
                                                    <select class="form-select" aria-label="Default select example"
                                                        name="inspectionNo" id="inspectionNo" disabled>
                                                        <option value="0">--select--</option>
                                                        {% for inspection in Approved_Inspection %}
                                                        <option value="{{inspection.PremiseInpectionNo}}">
                                                            {{inspection.PremiseInpectionNo}}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                {% if permit.FirstTimeApplication == "No" %}
                                                <div class="col-md-4">
                                                    <label class="form-label">Last Paid Date</label>
                                                    <input type="text" class="form-control"
                                                        value="{{permit.Last_Paid_Date}}" disabled>
                                                </div>
                                                {% else %}
                                                <div class="col-md-4">
                                                    <label class="form-label">Invoiced</label>
                                                    <input type="text" class="form-control" value="{{permit.Invoiced}}"
                                                        disabled>
                                                </div>
                                                {% endif %}
                                            </div>

                                        </div>
                                    </div>
                                    <div class="border border-success rounded p-3 my-3">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label">Premise Name</label>
                                                <input type="text" class="form-control" name="premiseName"
                                                    id="premiseName" value="{{permit.PremiseName}}" disabled>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Town <span
                                                        class="text-danger">*</span></label>
                                                <input type="text" class="form-control" name="town" id="town"
                                                    value="{{permit.Town}}" disabled>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Road <span
                                                        class="text-danger">*</span></label>
                                                <input type="text" class="form-control" name="road" id="road"
                                                    value="{{permit.Road}}" disabled>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-md-4">
                                                <label class="form-label">Building <span
                                                        class="text-danger">*</span></label>
                                                <input type="text" class="form-control" name="building" id="building"
                                                    value="{{permit.Building}}" disabled>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Plot No</label>
                                                <input type="text" class="form-control" name="plotNo" id="plotNo"
                                                    value="{{permit.Plot_No}}" disabled>
                                            </div>

                                        </div>
                                        {% if permit.Status == 'Open' %}
                                        <button type="submit" class="btn button-87 my-3 w-100">Edit Form</button>
                                        {% endif %}
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% include 'alert.html' %}
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div
                    class="steps d-flex flex-wrap flex-sm-nowrap justify-content-between padding-top-2x padding-bottom-1x">
                    <div class="step completed">
                        <div class="step-icon-wrap">
                            <div class="step-icon">
                                <i class="las la-check"></i>
                            </div>
                        </div>
                        <h4 class="step-title">Application Form</h4>
                    </div>
                    <div class="step step2Icon">
                        <div class="step-icon-wrap">
                            <div class="step-icon">
                                <i class="las la-user-tie"></i>
                            </div>
                        </div>
                        <h4 class="step-title">Professionals Form</h4>
                    </div>
                    <div class="step step3Icon">
                        <div class="step-icon-wrap">
                            <div class="step-icon">
                                <i class="las la-upload"></i>
                            </div>
                        </div>
                        <h4 class="step-title">Attachments</h4>
                    </div>
                    <div class="step step4con">
                        <div class="step-icon-wrap">
                            <div class="step-icon">
                                <i class="las la-coins"></i>
                            </div>
                        </div>
                        <h4 class="step-title">Payment</h4>
                    </div>
                    <div class="step step5con">
                        <div class="step-icon-wrap">
                            <div class="step-icon">
                                <i class="las la-check-double"></i>
                            </div>
                        </div>
                        <h4 class="step-title">Submit</h4>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
{% include 'footer.html' %}
<script>
    $(document).ready(function () {

        var Nationality = '{{permit.Nationality}}';
        var documentStatus = '{{permit.Status}}';
        var AmountPayable = '{{permit.AmountPayable}}';
        var document_header = '{{permit.RetailDealersNo}}';
        var Invoiced = '{{permit.Invoiced}}';
        var Paid = '{{permit.Paid}}';

        const $step2Icon = $('.step2Icon');
        const $stepTwo = $('#stepTwo');
        const $Professionals_btn = $('#Professionals_btn');
        const $ProfessionalsNext = $('#ProfessionalsNext');
        const $ProfessionalsForm = $('#ProfessionalsForm');
        const $spinner = $('#spinner');

        const $stepThree = $('#stepThree');
        const $FNGenerateInvoice = $('#FNGenerateInvoice');
        const $attachmentForm = $('#attachmentForm');
        const $AttachmentsPrev = $('#AttachmentsPrev');
        const $AttachmentsNext = $('#AttachmentsNext');
        const $stepFour = $('#stepFour');
        const $paymentPrev = $('#paymentPrev');
        const $payment_submit_form = $('#payment_submit_form');
        const $step4con = $('.step4con');
        const $step5con = $('.step5con');
        const $payment_state = $('#payment_state');
        const $PremiseCertForm = $('#PremiseCertForm');
        var progressBar = $(".progress-bar");

        function animateProgressBar(percentage) {
            var progressBar = document.querySelector('.progress-bar');
            progressBar.style.width = percentage + '%';

            var progressValue = document.querySelector('.doc_status');
            progressValue.textContent = percentage + '%'; // Update the progress value
        }

        Amount_Payable = parseInt(AmountPayable)

        filter_list(document_header);

        function filter_list(pk) {
            var query = '/QyRetailDealersPremisePermit'
            var filter_one = 'RetailDealersNo'
            var filter_two = 'UserCode'


            $.ajax({
                url: "/filter_list/" + pk,
                type: "GET",
                dataType: "json",
                data: {
                    query: query,
                    filter_one: filter_one,
                    filter_two: filter_two,
                },
                success: function (data) {
                    if (data['success'] == true) {
                        $('.document_status').empty().append(data['data']['Status']);

                        if (data['data']['Paid'] === true) {
                            $('#payment_submit_form').css('display', 'inline-block');
                            $step4con.addClass('completed');
                            $payment_state.empty().append("Paid");
                            $(".pesa_paid").addClass('text-success');
                        }
                        if (data['data']['Paid'] === true && data['data']['Status'] === 'Open') {
                            progressBar.css("width", "80%");
                            animateProgressBar(80);

                        }

                        if (data['data']['Status'] === 'Open') {
                            $(".confirm_div").show();
                            $stepTwo.show();
                            progressBar.addClass("bg-warning");
                            progressBar.css("width", "20%");
                            animateProgressBar(20);
                        } else if (data['data']['Status'] === 'Processing') {
                            $("#loading_div").show();
                            $('#payment_submit_form').css('display', 'none');
                            $step5con.addClass('completed');
                            $ProfessionalsForm.hide();
                            $attachmentForm.hide();
                            $(".confirm_div").hide();
                            $stepTwo.hide();
                            $stepThree.hide();
                            $stepFour.show();
                            progressBar.css("width", "80%");
                            progressBar.addClass("bg-primary");
                            animateProgressBar(80);
                        } else if (data['data']['Status'] === 'Approved') {
                            $('#cert_card').show();
                            $('#payment_submit_form').css('display', 'none');
                            $step5con.addClass('completed');
                            $ProfessionalsForm.hide();
                            $attachmentForm.hide();
                            $(".confirm_div").hide();
                            $stepTwo.hide();
                            $stepThree.hide();
                            $stepFour.show();
                            progressBar.css("width", "100%");
                            progressBar.addClass("bg-success");
                            animateProgressBar(100);
                        }

                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                },
            });

        }

        $ProfessionalsNext.click(function () {
            if (Invoiced === 'False' && Paid === 'False') {
                $spinner.show(400);
                document.getElementById('main').classList.add('loads');
                $ProfessionalsForm.hide();
                $.ajax({
                    type: 'POST',
                    url: '/RetailCustomer/',
                    data: {
                        RetailDealersNo: document_header,
                        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                    },
                    success: function (response) {
                        if (response['response']) {
                            iziToast.show({
                                theme: 'dark',
                                backgroundColor: '#239B56',
                                icon: 'las la-check-circle',
                                title: 'Yeah',
                                message: "Pay" + " " + AmountPayable,
                                position: 'topRight',
                                progressBarColor: '#F4F6F7',
                            });
                            $stepTwo.hide();
                            $stepThree.show();
                            $spinner.hide();
                        } else if (response['error']) {
                            iziToast.show({
                                theme: 'dark',
                                icon: 'las la-exclamation',
                                title: 'Error',
                                message: response['error'],
                                position: 'topRight',
                                progressBarColor: '#ff0800',
                            });
                            $ProfessionalsForm.show();

                        }
                        $spinner.hide(1000);
                        document.getElementById('main').classList.remove('loads');
                    },
                    error: function (error) {
                        console.log(error)
                        $spinner.hide(1000);
                        document.getElementById('main').classList.remove('loads');
                        $ProfessionalsForm.show();

                    }
                });
            } else {
                $stepTwo.hide();
                $stepThree.show();
            }
        })

        $paymentPrev.click(function () {
            $stepFour.hide();
            $stepThree.show();
        })


        if (documentStatus === 'Open') {
            $('#premiseName').prop('disabled', false);
            $('#town').prop('disabled', false);
            $('#road').prop('disabled', false);
            $('#building').prop('disabled', false);
            $('#firstTimeApplication').prop('disabled', false);
            $('#plotNo').prop('disabled', false);
            $('#applicantName').prop('disabled', false);
            $('#inspectionNo').prop('disabled', false);
        }

        $AttachmentsPrev.click(function () {
            $stepTwo.show();
            $stepThree.hide();
        })

        $AttachmentsNext.click(function () {
            $stepFour.show();
            $stepThree.hide();
            $(".step3Icon").addClass('completed');

        })

        $ProfessionalsForm.on('submit', (e) => {
            e.preventDefault();
            if ($('#pro_name').val() === '' || $('#position_in_business')
                .val() === '' || $('#qualificationAndExperience').val() === '' || $('#nationality')
                .val() === '' || $('#iDorPassportOrAlienIDNo')
                .val() === '') {
                alert('Please fill in all required fields.');
                return false;
            }
            $spinner.show(400);
            document.getElementById('main').classList.add('loads');
            $ProfessionalsForm.hide();

            $.ajax({
                type: 'POST',
                url: '/retailer/' + document_header + "/",
                data: {
                    myAction: $("#Professionals_my_action").val(),
                    lineNo: $('#Professionals_lineNo').val(),
                    pro_name: $('#pro_name').val(),
                    position_in_business: $('#position_in_business').val(),
                    nationality: $('#nationality').val(),
                    iDorPassportOrAlienIDNo: $('#iDorPassportOrAlienIDNo').val(),
                    professionalRegNo: $('#professionalRegNo').val(),
                    qualificationAndExperience: $('#qualificationAndExperience').val(),
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response['response']) {
                        loadProfessionals(document_header);
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#239B56',
                            icon: 'las la-check-circle',
                            title: 'Yeah',
                            message: "created successfully",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });
                        $('#pro_name, #position_in_business, #professionalRegNo, #nationality, #iDorPassportOrAlienIDNo')
                            .val(
                                '');
                        $('#qualificationAndExperience').val('');
                    } else if (response['error']) {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: response['error'],
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                    }
                    $ProfessionalsForm.show();
                    $spinner.hide(1000);
                    document.getElementById('main').classList.remove('loads');
                },
                error: function (error) {
                    console.log(error)
                    $ProfessionalsForm.show();
                    $spinner.hide(1000);
                    document.getElementById('main').classList.remove('loads');

                }
            });
        });

        function handleFormSubmission(form) {
            event.preventDefault();
            $spinner.show(400);
            document.getElementById('main').classList.add('loads');
            $ProfessionalsForm.hide();
            $.ajax({
                url: form.attr('action'),
                type: form.attr('method'),
                data: form.serialize(),
                success: function (response) {
                    loadProfessionals(document_header);
                    if (response['response']) {
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#239B56',
                            icon: 'las la-check-circle',
                            message: "deleted",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });
                    } else {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: response[
                                'message'],
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                    }
                    $ProfessionalsForm.show();
                    $spinner.hide(1000);
                    document.getElementById('main')
                        .classList.remove('loads');
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                    $ProfessionalsForm.show();
                    $spinner.hide(1000);
                    document.getElementById('main')
                        .classList.remove('loads');
                    iziToast.show({
                        theme: 'dark',
                        icon: 'las la-exclamation',
                        title: 'Error',
                        message: 'CSRF verification failed. Request aborted.',
                        position: 'topRight',
                        progressBarColor: '#ff0800',
                    });
                }
            });
        }

        loadProfessionals(document_header);

        function loadProfessionals(pk) {
            $.ajax({
                url: "/RetailProfessionals/" + pk + "/",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    var tableBody = $('#ProfessionalsTable tbody');
                    tableBody.empty(); // clear existing rows if any
                    // iterate through the data and append to the table
                    for (var i = 0; i < data[1].length; i++) {
                        if (data[1].length > 0) {
                            $step2Icon.addClass('completed');
                            $Professionals_btn.show();
                        } else {
                            $step2Icon.removeClass('completed');
                            $Professionals_btn.hide();
                        }
                        var Name = data[1][i].Name;
                        var Nationality = data[1][i].Nationality_Description;
                        var IDOrPassportOrAlienIDNo = data[1][i].IDOrPassportOrAlien_ID_No;
                        var PositionIntheBusiness = data[1][i].PositionIntheBusiness;
                        var ProfessionalRegNo = data[1][i].Professional_Reg__No;
                        var QualificationAndExperience = data[1][i].Qualification;
                        let Line_No = data[1][i].PremiseLineNo;

                        var row = $('<tr>');
                        row.append($('<td>').text(Name));
                        row.append($('<td>').text(ProfessionalRegNo));
                        row.append($('<td>').text(Nationality));
                        row.append($('<td>').text(IDOrPassportOrAlienIDNo));
                        row.append($('<td>').text(PositionIntheBusiness));
                        row.append($('<td>').text(QualificationAndExperience));
                        if (documentStatus === 'Open') {
                            var form = $('<form>').attr({
                                method: 'POST',
                                action: '/retailer/' + pk + '/',
                            }).append('{% csrf_token %}');

                            var pro_Name = $('<input>').attr({
                                type: 'hidden',
                                name: 'pro_name',
                                value: "0"
                            });
                            var pro_position_in_business = $('<input>').attr({
                                type: 'hidden',
                                name: 'position_in_business',
                                value: "0"
                            });
                            var pro_nationality = $('<input>').attr({
                                type: 'hidden',
                                name: 'nationality',
                                value: "KE"
                            });
                            var pro_iDorPassportOrAlienIDNo = $('<input>').attr({
                                type: 'hidden',
                                name: 'iDorPassportOrAlienIDNo',
                                value: "0"
                            });
                            var pro_professionalRegNo = $('<input>').attr({
                                type: 'hidden',
                                name: 'professionalRegNo',
                                value: "0"
                            });
                            var pro_qualificationAndExperience = $('<input>').attr({
                                type: 'hidden',
                                name: 'qualificationAndExperience',
                                value: "0"
                            });

                            var pro_lineNoInput = $('<input>').attr({
                                type: 'hidden',
                                name: 'lineNo',
                                value: Line_No
                            });
                            var pro_myActionInput = $('<input>').attr({
                                type: 'hidden',
                                name: 'myAction',
                                value: 'delete'
                            });
                            var pro_submitBtn = $('<button>').attr({
                                type: 'submit',
                                class: 'btn btn-danger'
                            }).text('delete');

                            // Handle form submission
                            form.submit(function (event) {
                                handleFormSubmission($(this));
                            });

                            var td = $('<td>').append(form.append(pro_Name,
                                pro_position_in_business,
                                pro_nationality,
                                pro_iDorPassportOrAlienIDNo,
                                pro_professionalRegNo,
                                pro_qualificationAndExperience, pro_lineNoInput,
                                pro_myActionInput, pro_submitBtn));
                            row.append(td);
                        }
                        tableBody.append(row);
                    }
                    // initialize DataTables for each table
                    if (!$.fn.DataTable.isDataTable('#ProfessionalsTable')) {
                        $('#ProfessionalsTable').DataTable({
                            "pageLength": 5,
                            "order": [
                                [0, "desc"]
                            ]
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                },
            });
        }


        $attachmentForm.on("submit", (e) => {
            e.preventDefault();
            $spinner.show(400);
            document.getElementById('main').classList.add('loads');
            var formData = new FormData($attachmentForm[0]);

            let attachments = $('#attachments')[0];
            for (let i = 0; i < attachments.files.length; i++) {
                formData.append('attachment', attachments.files[i]);
            }

            $.ajax({
                url: "/RetailPermitAttachments/" + document_header + "/",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
                },
                success: function (data) {

                    $('#attachments').val('');
                    if (data['success'] == true) {
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#239B56',
                            icon: 'las la-check-circle',
                            title: 'Yeah',
                            message: "Uploaded successfully",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });
                        Load_Attachments(document_header);
                    } else {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: "Upload failed: " + data,
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                        document.getElementById('main').classList.remove('loads');
                    }
                    $spinner.hide(1000);
                    document.getElementById('main').classList.remove('loads');
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.log(xhr.responseText);
                    $spinner.hide(1000);
                    document.getElementById('main').classList.remove('loads');
                }
            });
        });
        Load_Attachments(document_header);

        function Load_Attachments(pk) {
            $.ajax({
                url: "/RetailPermitAttachments/" + document_header + "/",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    var containerDiv = $("#attachments-container");
                    containerDiv.empty(); // clear the container div
                    for (var i = 0; i < data.length; i++) {
                        if (data.length > 0) {
                            $(".step3Icon").addClass('completed');
                        }
                        var docID = data[i].AuxiliaryIndex2;
                        var tableID = data[i].Table_ID;
                        var attachmentID = data[i].AuxiliaryIndex2;
                        var File_Name = data[i].File_Name;
                        var File_Extension = data[i].File_Extension;
                        // create a new div for this attachment
                        var attachmentDiv = $("<div>", {
                            class: "col-lg-4 col-xl-3"
                        });
                        var fileManBoxDiv = $("<div>", {
                            class: "file-man-box"
                        });
                        // create the form for deleting the attachment
                        if (documentStatus === 'Open') {
                            var deleteForm = $("<form>", {
                                method: "POST"
                            });
                            deleteForm.append($("<input>", {
                                type: "hidden",
                                name: "docID",
                                value: docID
                            }));
                            deleteForm.append($("<input>", {
                                type: "hidden",
                                name: "tableID",
                                value: tableID
                            }));
                            var deleteButton = $("<button>", {
                                class: "file-close",
                                id: "file-close",
                                style: "background-color: white !important;"
                            }).append($("<i>", {
                                class: "las la-times-circle",
                            }));
                            deleteButton.on("click", function (event) {
                                event.preventDefault();
                                $spinner.show(400);
                                document.getElementById('main').classList.add('loads');
                                $.ajax({
                                    type: 'POST',
                                    url: "/RemoveRetailAttachment/",
                                    data: {
                                        docID: docID,
                                        tableID: tableID,
                                        leaveCode: pk,
                                        csrfmiddlewaretoken: $(
                                                'input[name=csrfmiddlewaretoken]')
                                            .val()
                                    },
                                    success: function (data) {
                                        if (data['success'] == true) {
                                            iziToast.show({
                                                theme: 'dark',
                                                backgroundColor: '#239B56',
                                                icon: 'las la-check-circle',
                                                title: 'Yeah',
                                                message: data[
                                                    'message'],
                                                position: 'topRight',
                                                progressBarColor: '#F4F6F7',
                                            });
                                            Load_Attachments(pk);
                                        } else {
                                            iziToast.show({
                                                theme: 'dark',
                                                icon: 'las la-exclamation',
                                                title: 'Error',
                                                message: data['error'],
                                                position: 'topRight',
                                                progressBarColor: '#ff0800',
                                            });
                                        }
                                        $spinner.hide(1000);
                                        document.getElementById('main')
                                            .classList.remove('loads');
                                    },
                                    error: function (error) {
                                        console.log(error)
                                        $spinner.hide(1000);
                                        document.getElementById('main')
                                            .classList.remove('loads');
                                    }
                                });
                            });
                            fileManBoxDiv.append(deleteButton);
                        }
                        // create the div for the file icon
                        var fileImgBoxDiv = $("<div>", {
                            class: "file-img-box"
                        }).append($("<img>", {
                            src: "../../static/img/file-download.png",
                            alt: "icon"
                        }));
                        fileManBoxDiv.append(fileImgBoxDiv);
                        // create the div for the file name
                        var fileManTitleDiv = $("<div>", {
                            class: "file-man-title"
                        }).append($("<h5>", {
                            class: "mb-0 text-overflow"
                        }).text(File_Name + "." + File_Extension));
                        fileManBoxDiv.append(fileManTitleDiv);
                        attachmentDiv.append(fileManBoxDiv);
                        containerDiv.append(attachmentDiv);
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                },
            });
        }


        $FNGenerateInvoice.on('submit', (e) => {
            e.preventDefault();
            $spinner.show(400);
            document.getElementById('main').classList.add('loads');
            $.ajax({
                type: 'POST',
                url: '/RetailerInvoice/',
                data: {
                    premiseNo: document_header,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                xhrFields: {
                    responseType: 'blob' // Set the response type to 'blob'
                },
                success: function (response) {
                    const blob = new Blob([response], {
                        type: 'application/pdf'
                    });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'Premise_Invoice.pdf';
                    link.click();
                    window.URL.revokeObjectURL(url);

                    iziToast.show({
                        theme: 'dark',
                        backgroundColor: '#239B56',
                        icon: 'las la-check-circle',
                        title: 'Success',
                        message: 'Downloaded successfully',
                        position: 'topRight',
                        progressBarColor: '#F4F6F7',
                    });
                    $spinner.hide(1000);
                    document.getElementById('main')
                        .classList.remove('loads');
                },
                error: function (error) {
                    console.log(error);
                    $spinner.hide(1000);
                    document.getElementById('main')
                        .classList.remove('loads');
                    iziToast.show({
                        theme: 'dark',
                        backgroundColor: '#E74C3C',
                        icon: 'las la-times-circle',
                        title: 'Error',
                        message: 'An error occurred',
                        position: 'topRight',
                        progressBarColor: '#F4F6F7',
                    });
                }
            });
        });

        $payment_submit_form.on('submit', (e) => {
            e.preventDefault();
            $spinner.show(400);
            document.getElementById('main').classList.add('loads');

            $.ajax({
                type: 'POST',
                url: '/submit/retail/' + document_header + "/",
                data: {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response['response']) {
                        filter_list(document_header);
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#239B56',
                            icon: 'las la-check-circle',
                            title: 'Yeah',
                            message: "submitted successfully",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });

                    } else if (response['error']) {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: response['error'],
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                    }
                    $spinner.hide(1000);
                    document.getElementById('main')
                        .classList.remove('loads');
                },
                error: function (error) {
                    console.log(error)
                    $spinner.hide(1000);
                    document.getElementById('main')
                        .classList.remove('loads');

                }
            });
        });

        $PremiseCertForm.on('submit', (e) => {
            e.preventDefault();
            $spinner.show(400);
            document.getElementById('main').classList.add('loads');
            $.ajax({
                type: 'POST',
                url: '/retail/cert/' + document_header + '/',
                data: {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                xhrFields: {
                    responseType: 'blob'
                },
                success: function (response) {
                    const blob_cert = new Blob([response], {
                        type: 'application/pdf'
                    });
                    const urls = window.URL.createObjectURL(blob_cert);
                    const links = document.createElement('a');
                    links.href = urls;
                    links.download = 'Retail_Premise_Certificate.pdf';
                    links.click();
                    window.URL.revokeObjectURL(urls);

                    iziToast.show({
                        theme: 'dark',
                        backgroundColor: '#239B56',
                        icon: 'las la-check-circle',
                        title: 'Success',
                        message: 'Downloaded successfully',
                        position: 'topRight',
                        progressBarColor: '#F4F6F7',
                    });
                    $spinner.hide(1000);
                    document.getElementById('main')
                        .classList.remove('loads');
                },
                error: function (error) {
                    console.log(error);
                    $spinner.hide(1000);
                    document.getElementById('main')
                        .classList.remove('loads');
                    iziToast.show({
                        theme: 'dark',
                        backgroundColor: '#E74C3C',
                        icon: 'las la-times-circle',
                        title: 'Error',
                        message: 'An error occurred',
                        position: 'topRight',
                        progressBarColor: '#F4F6F7',
                    });
                }
            });
        });

    })
</script>
{% endblock %}